<!doctype html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Quest Runner - 파티 생성</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

</head>
<body>

<div class="container">
    <h2 class="text-center mb-4">⚔️ 새로운 파티 모집</h2>
    <p class="text-center text-muted mb-5">함께 모험을 떠날 동료를 구해보세요.</p>

    <form id="partyForm">
        <!-- 1. 기본 정보 -->
        <div class="mb-3">
            <label for="title" class="form-label fw-bold">파티 제목 <span class="text-danger">*</span></label>
            <input type="text" class="form-control" id="title" name="title" required minlength="5" maxlength="100"
                   placeholder="예: 사이드 프로젝트
    백엔드 개발자 구합니다!">
        </div>

        <div class="mb-3">
            <label for="region" class="form-label fw-bold">활동 지역 <span class="text-danger">*</span></label>
            <select class="form-select" id="region" name="region" required>
                <option value="" selected disabled>지역 선택</option>
                <option value="SEOUL">서울</option>
                <option value="GYEONGGI">경기/인천</option>
                <option value="DAEJEON">대전/충청</option>
                <option value="BUSAN">부산/경남</option>
                <option value="GWANGJU">광주/전라</option>
                <option value="ETC">기타 (온라인 포함)</option>
            </select>
        </div>

        <div class="mb-3">
            <label for="content" class="form-label fw-bold">상세 내용 <span class="text-danger">*</span></label>
            <textarea class="form-control" id="content" name="content" rows="6" required placeholder="프로젝트 주제, 예상 기간, 기술 스택 등을 자세히
       적어주세요."></textarea>
        </div>

        <!-- 2. 모집 슬롯 (핵심 UI) -->
        <div class="mb-4">
            <label class="form-label fw-bold">모집 포지션 (슬롯) <span class="text-danger">*</span></label>
            <div class="card bg-light border-0">
                <div class="card-body">
                    <div class="d-flex gap-2 mb-3">
                        <select class="form-select w-auto" id="slotSelect">
                            <option value="BACKEND">백엔드</option>
                            <option value="FRONTEND">프론트엔드</option>
                            <option value="DESIGN">디자이너</option>
                            <option value="PM">기획자(PM)</option>
                        </select>
                        <button type="button" class="btn btn-outline-primary" onclick="addSlot()">+ 추가</button>
                    </div>

                    <div id="slotContainer">
                        <!-- 추가된 슬롯들이 여기에 배지로 표시됨 -->
                        <span class="text-muted small" id="emptySlotMsg">모집할 포지션을 추가해주세요.</span>
                    </div>
                </div>
            </div>
            <div id="slotError" class="text-danger mt-1 small" style="display:none;">최소 1명 이상의 모집 슬롯이 필요합니다.</div>
        </div>

        <div class="d-grid gap-2">
            <button type="submit" class="btn btn-primary btn-lg">파티 생성 완료</button>
            <a href="/oauth-success.html" class="btn btn-secondary">취소</a>
        </div>
    </form>
</div>

<script>
    const accessToken = localStorage.getItem("accessToken");
    if (!accessToken) {
        alert("로그인이 필요합니다.");
        window.location.href = "/login.html";
    }

    // 슬롯 상태 관리 (배열)
    let slots = [];

    function addSlot() {
        const select = document.getElementById("slotSelect");
        const position = select.value;
        const label = select.options[select.selectedIndex].text;

        // 배열에 추가
        slots.push(position);
        renderSlots();
    }

    function removeSlot(index) {
        slots.splice(index, 1);
        renderSlots();
    }

    function renderSlots() {
        const container = document.getElementById("slotContainer");
        const msg = document.getElementById("emptySlotMsg");
        const error = document.getElementById("slotError");

        container.innerHTML = "";

        if (slots.length === 0) {
            if (msg) msg.style.display = "inline";
            error.style.display = "block";
        } else {
            if (msg) msg.style.display = "none";
            error.style.display = "none";

            slots.forEach((pos, index) => {
                // 포지션별 색상 구분 (간단히)
                let badgeClass = "bg-primary";
                if (pos === 'DESIGN') badgeClass = "bg-danger";
                else if (pos === 'PM') badgeClass = "bg-warning text-dark";
                else if (pos === 'FRONTEND') badgeClass = "bg-success";

                const badge = document.createElement("span");
                badge.className = `badge rounded-pill ${badgeClass} slot-badge`;
                badge.innerHTML = `${pos} <button type="button" class="btn-close btn-close-white" onclick="removeSlot(${index})"></button>`;
                container.appendChild(badge);
            });
        }
    }

    // 폼 전송
    document.getElementById("partyForm").addEventListener("submit", function (e) {
        e.preventDefault();

        if (slots.length === 0) {
            document.getElementById("slotError").style.display = "block";
            return;
        }

        const data = {
            title: document.getElementById("title").value,
            content: document.getElementById("content").value,
            region: document.getElementById("region").value,
            slots: slots
        };

        fetch('/api/parties', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + accessToken
            },
            body: JSON.stringify(data)
        })
            .then(async response => {
                const res = await response.json();
                if (!response.ok) {
                    // 1인 1파티 제한 등 에러 처리
                    throw new Error(res.message || "파티 생성 실패");
                }
                return res;
            })
            .then(res => {
                alert(res.message); // "파티가 성공적으로 생성되었습니다."
                window.location.href = "/oauth-success.html"; // 생성 후 홈으로 이동 (추후 상세페이지로)
            })
            .catch(err => {
                console.error(err);
                alert(err.message);
            });
    });
</script>

</body>

<style>
    body {
        padding-top: 50px;
        background-color: #f8f9fa;
    }

    .container {
        max-width: 800px;
        background: white;
        padding: 40px;
        border-radius: 15px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }

    .slot-badge {
        font-size: 0.9rem;
        padding: 8px 12px;
        margin-right: 5px;
        margin-bottom: 5px;
        cursor: pointer;
        display: inline-flex;
        align-items: center;

    }

    .slot-badge .btn-close {
        margin-left: 8px;
        font-size: 0.7rem;
    }
</style>
</html>
