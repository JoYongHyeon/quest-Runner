<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Quest Runner</title>
    <!-- Bootstrap ì¶”ê°€ -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { font-family: sans-serif; text-align: center; padding-top: 100px; background-color: #f8f9fa; }
        .container { max-width: 500px; background: white; padding: 40px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
    </style>
</head>
<body>

<!-- id="content" ì¶”ê°€: JSê°€ ì´ê³³ì— ë‚´ìš©ì„ ì±„ì›Œë„£ìŠµë‹ˆë‹¤ -->
<div class="container" id="content">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-3 text-muted">ëª¨í—˜ê°€ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
</div>

<script>
    // 1. URL ì¿¼ë¦¬ íŒŒë¼ë¯¸í„° ë˜ëŠ” ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ accessToken ì¶”ì¶œ
    const params = new URLSearchParams(window.location.search);
    let accessToken = params.get("accessToken");

    if (accessToken) {
        localStorage.setItem("accessToken", accessToken);
        // URL íŒŒë¼ë¯¸í„° ì œê±° (ë³´ì•ˆ ë° ê¹”ë”í•œ URL)
        window.history.replaceState({}, document.title, window.location.pathname);
    } else {
        accessToken = localStorage.getItem("accessToken");
    }

    if (accessToken) {
        // ë‚´ ì •ë³´ ì¡°íšŒ API í˜¸ì¶œ
        fetch('api/members/me', {
            method: 'GET',
            headers: {'Authorization': 'Bearer ' + accessToken}
        })
        .then(response => {
            if (!response.ok) throw new Error("ì¸ì¦ ì‹¤íŒ¨");
            return response.json();
        })
        .then(res => {
            const member = res.data;
            const contentDiv = document.getElementById('content');

            if (member.status === 'PENDING_PROFILE') {
                // [Case A] ì˜¨ë³´ë”© ë¯¸ì™„ë£Œ -> ê°•ì œ ì´ë™
                alert('ê°€ì…ì„ í™˜ì˜í•©ë‹ˆë‹¤!\nì›í™œí•œ ë§¤ì¹­ì„ ìœ„í•´ í”„ë¡œí•„ì„ ì™„ì„±í•´ì£¼ì„¸ìš”.');
                window.location.href = '/onboarding.html';
            } else {
                // [Case B] ì˜¨ë³´ë”© ì™„ë£Œ -> ë©”ì¸ í™”ë©´(í™ˆ) ë Œë”ë§
                contentDiv.innerHTML = `
                <div class="mb-5">
                    <h2 class="text-primary fw-bold mb-2">ğŸ‰ í™˜ì˜í•©ë‹ˆë‹¤!</h2>
                    <h3 class="fw-bold text-dark">${member.nickname}ë‹˜</h3>
                    <div class="mt-3">
                        <span class="badge bg-primary px-3 py-2 me-1">${member.position}</span>
                        <span class="badge bg-secondary px-3 py-2">${member.region}</span>
                    </div>
                    <p class="text-muted mt-3 small">ì¤€ë¹„ëœ ëª¨í—˜ê°€ì…ë‹ˆë‹¤.</p>
                </div>

                <div class="d-grid gap-3">
                    <a href="/party-create.html" class="btn btn-primary btn-lg py-3 fw-bold shadow-sm">
                        âš”ï¸ íŒŒí‹° ëª¨ì§‘í•˜ê¸° (Quest ìƒì„±)
                    </a>
                    <a href="/party-list.html" class="btn btn-outline-success btn-lg py-3 fw-bold">
                        ğŸ›¡ï¸ íŒŒí‹° ì°¾ê¸° (Coming Soon)
                    </a>
                    <a href="/my-party.html" class="btn btn-outline-secondary btn-lg py-3 fw-bold">
                        ğŸ‘‘ ë‚´ íŒŒí‹° ê´€ë¦¬ (Leader Mode)
                    </a>
                </div>
                `;
            }
        })
        .catch(err => {
            console.error(err);
            alert('ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
            localStorage.removeItem("accessToken");
            window.location.href = "/login.html";
        })
    } else {
        alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
        window.location.href = "/login.html";
    }
</script>
</body>
</html>
