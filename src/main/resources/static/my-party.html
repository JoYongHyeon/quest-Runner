<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Quest Runner - ë‚´ íŒŒí‹° ê´€ë¦¬</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding-top: 50px; background-color: #f8f9fa; }
        .container { max-width: 800px; }
        .party-card { border-left: 5px solid #ffc107; transition: transform 0.2s; }
        .party-card:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
    </style>
</head>
<body>

<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold">ğŸ‘‘ ë‚´ íŒŒí‹° ê´€ë¦¬</h2>
        <a href="/oauth-success.html" class="btn btn-outline-secondary">í™ˆìœ¼ë¡œ</a>
    </div>

    <!-- ë‚´ íŒŒí‹° ëª©ë¡ -->
    <div id="myPartyList" class="row g-3">
        <div class="text-center py-5">ë¡œë”© ì¤‘...</div>
    </div>
</div>

<!-- ì§€ì›ì ê´€ë¦¬ ëª¨ë‹¬ -->
<div class="modal fade" id="manageModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning text-white">
                <h5 class="modal-title fw-bold">ğŸ“œ ì§€ì›ì ëª©ë¡ (Applicants)</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="applicantList" class="list-group"></div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const accessToken = localStorage.getItem("accessToken");
    if (!accessToken) {
        alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
        window.location.href = "/login.html";
    }

    // 1. ë‚´ íŒŒí‹° ëª©ë¡ ì¡°íšŒ
    fetch('/api/parties/my', {
        headers: { 'Authorization': 'Bearer ' + accessToken }
    })
    .then(res => res.json())
    .then(res => {
        const list = document.getElementById("myPartyList");
        const parties = res.data;

        if (!parties || parties.length === 0) {
            list.innerHTML = `
                <div class="col-12 text-center py-5">
                    <p class="text-muted mb-3">ì•„ì§ ìƒì„±í•œ íŒŒí‹°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
                    <a href="/party-create.html" class="btn btn-primary">íŒŒí‹° ìƒì„±í•˜ëŸ¬ ê°€ê¸°</a>
                </div>`;
            return;
        }

        list.innerHTML = parties.map(party => `
            <div class="col-12">
                <div class="card party-card shadow-sm p-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h5 class="card-title fw-bold mb-1">${party.title}</h5>
                            <span class="badge bg-secondary">${party.status}</span>
                            <span class="text-muted small ms-2">${party.createdAt}</span>
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-outline-primary" onclick="location.href='/party-detail.html?id=${party.partyId}'">ìƒì„¸ ë³´ê¸°</button>
                            <button class="btn btn-warning fw-bold text-white" onclick="openManageModal(${party.partyId})">ì§€ì›ì ê´€ë¦¬</button>
                        </div>
                    </div>
                </div>
            </div>
        `).join('');
    })
    .catch(err => {
        console.error(err);
        alert("ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
    });

    // 2. ê´€ë¦¬ ëª¨ë‹¬ ì—´ê¸° & ì§€ì›ì ì¡°íšŒ
    function openManageModal(partyId) {
        const modal = new bootstrap.Modal(document.getElementById('manageModal'));
        modal.show();
        loadApplicants(partyId);
    }

    // 3. ì§€ì›ì ëª©ë¡ ì¡°íšŒ
    function loadApplicants(partyId) {
        const list = document.getElementById("applicantList");
        list.innerHTML = '<div class="text-center py-3">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';

        fetch(`/api/parties/${partyId}/applicants`, {
            headers: { 'Authorization': 'Bearer ' + accessToken }
        })
        .then(res => res.json())
        .then(res => {
            const applicants = res.data;
            if (!applicants || applicants.length === 0) {
                list.innerHTML = '<div class="text-center py-3 text-muted">ì•„ì§ ì§€ì›ìê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }

            list.innerHTML = applicants.map(app => `
                <div class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-1 fw-bold">${app.nickname} <small class="text-muted">(${app.position})</small></h6>
                        <p class="mb-1 small text-dark">"${app.message || "ë©”ì‹œì§€ ì—†ìŒ"}"</p>
                        <span class="badge bg-${app.status === 'PENDING' ? 'warning' : (app.status === 'ACCEPTED' ? 'success' : 'danger')}">
                            ${app.status}
                        </span>
                    </div>
                    ${app.status === 'PENDING' ? `
                    <div class="btn-group">
                        <button class="btn btn-sm btn-outline-success" onclick="decideApplicant(${app.applicantId}, 'ACCEPTED', ${partyId})">ìˆ˜ë½</button>
                        <button class="btn btn-sm btn-outline-danger" onclick="decideApplicant(${app.applicantId}, 'REJECTED', ${partyId})">ê±°ì ˆ</button>
                    </div>` : ''}
                </div>
            `).join('');
        })
        .catch(err => list.innerHTML = `<div class="text-danger text-center">${err.message}</div>`);
    }

    // 4. ìˆ˜ë½/ê±°ì ˆ API í˜¸ì¶œ
    function decideApplicant(applicantId, status, partyId) {
        if (!confirm(`${status === 'ACCEPTED' ? 'ìˆ˜ë½' : 'ê±°ì ˆ'}í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

        fetch(`/api/parties/applicants/${applicantId}`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + accessToken
            },
            body: JSON.stringify({ status: status })
        })
        .then(res => res.json())
        .then(res => {
            if (res.code !== 'P-S003') throw new Error(res.message);
            
            alert(res.message);
            loadApplicants(partyId); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        })
        .catch(err => alert(err.message));
    }
</script>
</body>
</html>