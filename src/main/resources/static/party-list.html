<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Quest Runner - íŒŒí‹° ì°¾ê¸°</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

</head>
<body>

<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold">ğŸ›¡ï¸ íŒŒí‹° ì°¾ê¸°</h2>
        <a href="/oauth-success.html" class="btn btn-outline-secondary">í™ˆìœ¼ë¡œ</a>
    </div>

    <!-- ê²€ìƒ‰ í•„í„° -->
    <div class="card mb-4 border-0 shadow-sm">
        <div class="card-body">
            <form id="searchForm" class="row g-2">
                <div class="col-md-4">
                    <select class="form-select" name="region">
                        <option value="">ì§€ì—­ ì „ì²´</option>
                        <option value="SEOUL">ì„œìš¸</option>
                        <option value="GYEONGGI">ê²½ê¸°/ì¸ì²œ</option>
                        <option value="ETC">ê¸°íƒ€ (ì˜¨ë¼ì¸)</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <select class="form-select" name="position">
                        <option value="">í¬ì§€ì…˜ ì „ì²´</option>
                        <option value="BACKEND">ë°±ì—”ë“œ</option>
                        <option value="FRONTEND">í”„ë¡ íŠ¸ì—”ë“œ</option>
                        <option value="DESIGN">ë””ìì´ë„ˆ</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <button type="submit" class="btn btn-primary w-100">ê²€ìƒ‰</button>
                </div>
            </form>
        </div>
    </div>

    <!-- íŒŒí‹° ëª©ë¡ ì˜ì—­ -->
    <div id="partyList" class="row g-3">
        <!-- JSë¡œ ë™ì  ë Œë”ë§ -->
    </div>

    <!-- ë”ë³´ê¸° ë²„íŠ¼ -->
    <div class="text-center mt-4">
        <button id="loadMoreBtn" class="btn btn-light text-secondary" onclick="loadParties()">ë” ë³´ê¸°</button>
    </div>
</div>

<script>
    const accessToken = localStorage.getItem("accessToken");
    let currentPage = 0;
    const pageSize = 10;
    let isLastPage = false;

    // ì´ˆê¸° ë¡œë”©
    loadParties();

    document.getElementById("searchForm").addEventListener("submit", function(e) {
        e.preventDefault();
        // ê²€ìƒ‰ ì‹œ ì´ˆê¸°í™”
        loadParties(true);
    });

    function loadParties(reset = false) {
        if (reset) {
            currentPage = 0;
            isLastPage = false;
            document.getElementById("partyList").innerHTML = "";
            document.getElementById("loadMoreBtn").style.display = "inline-block";
        }

        if (isLastPage) return;

        // ê²€ìƒ‰ ì¡°ê±´ íŒŒë¼ë¯¸í„° ìƒì„±
        const form = document.getElementById("searchForm");
        const region = form.region.value;
        const position = form.position.value;

        let url = `/api/parties?page=${currentPage}&size=${pageSize}`;
        if (region && region !== "") url += `&region=${region}`;
        if (position && position !== "") url += `&position=${position}`;

        fetch(url, {
            method: 'GET',
            headers: {'Authorization': 'Bearer ' + accessToken}
        })
        .then(res => res.json())
        .then(res => {
            const parties = res.data.content;
            const listContainer = document.getElementById("partyList");

            if (parties.length === 0 && currentPage === 0) {
                listContainer.innerHTML = `<div class="text-center text-muted py-5">ëª¨ì§‘ ì¤‘ì¸ íŒŒí‹°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
                document.getElementById("loadMoreBtn").style.display = "none";
                return;
            }

            console.log(parties)

            parties.forEach(party => {
                const card = document.createElement("div");
                card.className = "col-12";
                card.innerHTML = `
                    <div class="card party-card p-3" onclick="location.href='/party-detail.html?id=${party.partyId}'">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h5 class="card-title fw-bold mb-1">${party.title}</h5>
                                <p class="card-text text-muted small mb-2">
                                    <span class="badge bg-light text-dark border me-1">${party.region}</span>
                                    ë¦¬ë”: ${party.leaderNickname}
                                </p>
                                <div class="d-flex gap-1">
                                    ${party.slots.map(slot =>
                                        `<span class="badge ${slot.status === 'OPEN' ? 'bg-success' : 'bg-secondary'} bg-opacity-75">
                                            ${slot.position} (${slot.status})
                                        </span>`
                                    ).join('')}
                                </div>
                            </div>
                            <span class="badge bg-primary status-badge">${party.status}</span>
                        </div>
                    </div>
                `;
                listContainer.appendChild(card);
            });

            if (res.data.last) {
                isLastPage = true;
                document.getElementById("loadMoreBtn").style.display = "none";
            } else {
                currentPage++;
            }
        })
        .catch(err => console.error(err));
    }
</script>
</body>
<style>
    body {
        padding-top: 50px;
        background-color: #f8f9fa;
    }

    .container {
        max-width: 900px;
    }

    .party-card {
        cursor: pointer;
        transition: transform 0.2s;
        border: none;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .party-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    .status-badge {
        font-size: 0.8rem;
    }
</style>
</html>
